/*!
 * myclops v1.0.0
 * (c) 2025 Sudeep
 * Released under the MIT License
 */
function e(e,t,i,r){return new(i||(i=Promise))((function(s,n){function o(e){try{c(r.next(e))}catch(e){n(e)}}function a(e){try{c(r.throw(e))}catch(e){n(e)}}function c(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}c((r=r.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;class t{constructor(e,t,i,r){this.baseEndpoint=e,this.apiKey=t,this.retryAttempts=i,this.retryDelay=r}dispatchEvents(t){return e(this,void 0,void 0,(function*(){console.log("yevents",t);let e=0;for(let i=0;i<t.length;i++){const r=t[i],s=r.event,n=this.getEndpoint(s);for(console.log(e<this.retryAttempts,n);e<this.retryAttempts&&n;)try{const e=yield fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({event:r})});if(console.log("response",e),!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return}catch(t){if(e++,console.log("attempts+",e),e===this.retryAttempts)throw t;yield new Promise((t=>setTimeout(t,this.retryDelay*e)))}}}))}getEndpoint(e){return{session_start:`${this.baseEndpoint}/sessions`,page_data:`${this.baseEndpoint}/page-analytics`,device_info:`${this.baseEndpoint}/device-info`,utm_params:`${this.baseEndpoint}/utm-tracking`,add_to_cart:`${this.baseEndpoint}/add-to-cart`,proceed_to_checkout:`${this.baseEndpoint}/proceed-to-checkout`,proceed_to_payment:`${this.baseEndpoint}/proceed-to-payment`,feature_product:`${this.baseEndpoint}/feature-products`,add_to_favourites:`${this.baseEndpoint}/add-to-favourites`,search:`${this.baseEndpoint}/search-bar`,event:`${this.baseEndpoint}/events`,conversion:`${this.baseEndpoint}/conversions`,clicks:`${this.baseEndpoint}/clicks`}[e]||null}}class i{constructor(e,t,i){this.sessionTimeout=e,this.storage=t,this.onSessionStart=i,this.sessionId=this.generateSessionId(),this.lastActivity=Date.now(),this.startActivityTracking()}generateSessionId(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}startActivityTracking(){["mousedown","keydown","touchstart","scroll"].forEach((e=>{window.addEventListener(e,(()=>this.updateActivity()),{passive:!0})})),this.checkInterval=setInterval((()=>this.checkSession()),6e4)}updateActivity(){this.lastActivity=Date.now()}checkSession(){Date.now()-this.lastActivity>this.sessionTimeout&&(this.sessionId=this.generateSessionId(),this.onSessionStart())}getSessionId(){return null!==localStorage.getItem("sessionId")?localStorage.getItem("sessionId")||"":(localStorage.setItem("sessionId",this.sessionId),this.sessionId)}getLiveSessionId(){return localStorage.getItem("sessionId")||null}destroy(){clearInterval(this.checkInterval)}}class r{constructor(e,t){this.updateThreshold=e,this.onUpdate=t,this.startTime=Date.now(),this.startTracking()}startTracking(){this.updateInterval=setInterval((()=>{this.onUpdate({pageUrl:window.location.href,timeOnPage:Date.now()-this.startTime,scrollDepth:this.getScrollDepth(),viewport:{width:window.innerWidth,height:window.innerHeight}})}),this.updateThreshold)}getScrollDepth(){const e=window.innerHeight,t=document.documentElement.scrollHeight;return window.pageYOffset/(t-e)*100}getCurrentPageData(){return{url:window.location.href,referrer:document.referrer,title:document.title,timeOnPage:Date.now()-this.startTime}}destroy(){clearInterval(this.updateInterval)}}class s{constructor(){this.deviceInfo=this.gatherDeviceInfo()}gatherDeviceInfo(){return{userAgent:navigator.userAgent,language:navigator.language,platform:navigator.platform,screenResolution:{width:window.screen.width,height:window.screen.height,pixelRatio:window.devicePixelRatio},browser:this.getBrowserInfo(),os:this.getOperatingSystem(),device:this.getDeviceType(),connection:this.getConnectionInfo(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,colorDepth:window.screen.colorDepth}}getBrowserInfo(){const e=navigator.userAgent;let t="unknown",i="unknown",r=e.match(/(chrome|chromium|crios)\/(\d+)/i);return r&&(t="Chrome",i=r[2]),r=e.match(/(firefox|fxios)\/(\d+)/i),r&&(t="Firefox",i=r[2]),r=e.match(/version\/(\d+).*safari/i),r&&(t="Safari",i=r[1]),r=e.match(/edge\/(\d+)/i),r&&(t="Edge",i=r[1]),`${t} ${i}`}getOperatingSystem(){const e=navigator.userAgent;let t="unknown";return-1!==e.indexOf("Win")&&(t="Windows"),-1!==e.indexOf("Mac")&&(t="MacOS"),-1!==e.indexOf("Linux")&&(t="Linux"),-1!==e.indexOf("Android")&&(t="Android"),-1!==e.indexOf("like Mac")&&(t="iOS"),t}getDeviceType(){const e=navigator.userAgent;return/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(e)?"tablet":/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(e)?"mobile":"desktop"}getConnectionInfo(){const e=navigator.connection;return e?{effectiveType:e.effectiveType,downlink:e.downlink,rtt:e.rtt,saveData:e.saveData}:null}getInfo(){return this.deviceInfo}}class n{constructor(){this.utmParams=this.extractUTMParameters(),this.setupHistoryListener()}extractUTMParameters(){const e=new URLSearchParams(window.location.search),t={};return["utm_source","utm_medium","utm_campaign","utm_term","utm_content","utm_campaign_id"].forEach((i=>{const r=e.get(i);r&&(t[i]=r)})),t}setupHistoryListener(){window.addEventListener("popstate",(()=>{this.utmParams=this.extractUTMParameters()}));const e=history.pushState,t=history.replaceState;history.pushState=(...t)=>{e.apply(history,t),this.utmParams=this.extractUTMParameters()},history.replaceState=(...e)=>{t.apply(history,e),this.utmParams=this.extractUTMParameters()}}getParameters(){return Object.assign({},this.utmParams)}}class o{constructor(){this.schemas={add_to_cart:{required:["productId","productCost","currency","productName","userId"],types:{productId:"string",productCost:"number",currency:"string",productName:"string",userId:"string"}},proceed_to_checkout:{required:["productIds","cartValue","currency","productName","userId"],types:{productIds:"object",cartValue:"number",currency:"string",productName:"string",userId:"string"}},proceed_to_payment:{required:["productIds","cartValue","currency","productName","userId"],types:{productIds:"object",cartValue:"number",currency:"string",productName:"string",userId:"string"}},feature_product:{required:["productId","productCost","currency","productName","userId"],types:{productId:"string",productCost:"number",currency:"string",productName:"string",userId:"string"}},add_to_favourites:{required:["userId","pageUrl","productName","productId"],types:{userId:"string",pageUrl:"string",productName:"string",productId:"string"}},search:{required:["searchTerm","userId"],types:{searchTerm:"string",userId:"string"}},utm_params:{required:[],types:{utm_source:"string",utm_medium:"string",utm_campaign_name:"string",utm_campaign_id:"string",utm_term:"string",utm_content:"string"}},session_data:{required:["sessionId","startTime","lastActivityTime","deviceInfo"],types:{sessionId:"string",startTime:"number",lastActivityTime:"number",deviceInfo:"object"}},page_time_data:{required:["url","title","referrer","timeOnPage","scrollDepth","interactions"],types:{url:"string",title:"string",referrer:"string",timeOnPage:"number",scrollDepth:"number",interactions:"number"}},device_info:{required:["userAgent","language","platform","screenResolution","browser","os","device","connection","timezone","colorDepth"],types:{userAgent:"string",language:"string",platform:"string",screenResolution:"object",browser:"string",os:"string",device:"string",connection:"object",timezone:"string",colorDepth:"number"}}}}validate(e,t){const i=this.schemas[e];if(i){for(const r of i.required)if(!(r in t))throw new Error(`Missing required field: ${r} for event: ${e}`);for(const[r,s]of Object.entries(i.types))if(r in t){const i=Array.isArray(t[r])?"object":typeof t[r];if(i!==s)throw new Error(`Invalid type for field: ${r} in event: ${e}. Expected ${s}, got ${i}`)}}else if("object"!=typeof t||null===t)throw new Error(`Invalid data format for event: ${e}`)}}class a{constructor(e){this.storageKey=e}storeFailedEvent(e){try{const t=this.getFailedEvents();t.push(Object.assign(Object.assign({},e),{timestamp:Date.now(),retryCount:0})),localStorage.setItem(this.storageKey,JSON.stringify(t))}catch(e){console.error("Failed to store event:",e)}}getFailedEvents(){try{const e=localStorage.getItem(this.storageKey);return e?JSON.parse(e):[]}catch(e){return console.error("Failed to retrieve events:",e),[]}}clearFailedEvents(){try{localStorage.removeItem(this.storageKey)}catch(e){console.error("Failed to clear events:",e)}}updateFailedEvent(e,t){try{const i=this.getFailedEvents();i[e]=t,localStorage.setItem(this.storageKey,JSON.stringify(i))}catch(e){console.error("Failed to update event:",e)}}}class c{constructor(e){this.maxSize=e,this.queue=[]}enqueue(e){this.queue.length>=this.maxSize&&this.queue.shift(),this.queue.push(e)}dequeue(){return this.queue.shift()}getEvents(){return[...this.queue]}clearEvents(){this.queue=[]}size(){return this.queue.length}}class d{constructor(){this.debugMode=!1}setDebug(e){this.debugMode=e}debug(...e){this.debugMode&&console.debug("[MySDK]",...e)}info(...e){console.info("[MySDK]",...e)}warn(...e){console.warn("[MySDK]",...e)}error(...e){console.error("[MySDK]",...e)}}const u={endpoint:"https://myclops-dapi.edalytics.com/api",debug:!1,batchInterval:5e3,sessionTimeout:18e5,pageTimeThreshold:1e3,retryAttempts:3,retryDelay:1e3,storageKey:"mysdk_storage",maxQueueSize:100};class h{constructor(){this.initialized=!1,this.plugins=[],this.logger=new d,this.storage=new a(u.storageKey),this.queueManager=new c(u.maxQueueSize),this.deviceInfo=new s,this.utmTracker=new n,this.eventValidator=new o,this.eventDispatcher={},this.sessionManager={},this.pageTracker={}}init(e){try{if(this.initialized)return void this.logger.warn("SDK already initialized");if(!e.apiKey)throw new Error("API key is required for initialization");this.config=Object.assign(Object.assign(Object.assign({},u),e),{endpoint:u.endpoint}),this.initialized=!0,this.initializeServices(),this.restoreQueuedEvents(),this.logger.debug("SDK initialized successfully",this.config)}catch(e){throw this.logger.error("Failed to initialize SDK",e),e}}initializeServices(){console.log("initializeServices"),this.eventDispatcher=new t(this.config.endpoint,this.config.apiKey,this.config.retryAttempts,this.config.retryDelay),this.sessionManager=new i(this.config.sessionTimeout,this.storage,(()=>this.trackSessionStart())),this.pageTracker=new r(this.config.pageTimeThreshold,(e=>this.trackPageData(e))),this.logger.setDebug(this.config.debug||!1),null===this.sessionManager.getLiveSessionId()&&this.collectInitialData()}collectInitialData(){console.log("collectInitialData");try{if(!this.initialized)return void this.logger.warn("SDK not initialized. Skipping initial data collection.");const e={sessionId:this.getSessionId(),deviceInfo:this.getDeviceInfo(),utmParams:this.getUTMParameters(),timestamp:Date.now(),trackingId:this.config.apiKey};this.trackEvent("session_start",e)}catch(e){this.logger.error("Failed to collect initial data",e)}}use(e){this.plugins.push(e),this.logger.debug("Plugin added to SDK")}addToCart(e){console.log("AddToCartEvent",e),this.trackEvent("add_to_cart",e)}proceedToCheckout(e){this.trackEvent("proceed_to_checkout",e)}proceedToPayment(e){this.trackEvent("proceed_to_payment",e)}trackFeatureProduct(e){this.trackEvent("feature_product",e)}addToFavourites(e){this.trackEvent("add_to_favourites",e)}trackSearch(e){this.trackEvent("search",e)}push(e,t){this.trackEvent(e,t)}trackEvent(t,i){return e(this,void 0,void 0,(function*(){console.log("trackEventTriggered",t);try{if(!this.initialized)throw new Error("SDK not initialized");this.eventValidator.validate(t,i);const e=this.enrichEventData(t,i),r=this.applyPlugins(e);this.queueManager.enqueue(r),yield this.dispatchQueuedEvents()}catch(e){this.logger.error(`Failed to track event: ${t}`,e),this.storage.storeFailedEvent({eventName:t,data:i})}}))}enrichEventData(e,t){return Object.assign({event:e,timestamp:Date.now(),sessionId:this.sessionManager.getSessionId(),deviceInfo:this.deviceInfo.getInfo(),utmParams:this.utmTracker.getParameters(),page:this.pageTracker.getCurrentPageData()},t)}applyPlugins(e){return window.dataLayer=window.dataLayer||[],window.dataLayer.push(e),this.plugins.reduce(((e,t)=>{try{return t(e)}catch(t){return this.logger.error("Plugin execution failed",t),e}}),e)}dispatchQueuedEvents(){return e(this,void 0,void 0,(function*(){try{console.log("triggering");const e=this.queueManager.getEvents();if(0===e.length)return;yield this.eventDispatcher.dispatchEvents(e),this.queueManager.clearEvents()}catch(e){this.logger.error("Failed to dispatch events",e)}}))}restoreQueuedEvents(){return e(this,void 0,void 0,(function*(){const e=this.storage.getFailedEvents();for(const t of e)console.log("failedEvents",t.eventName),yield this.trackEvent(t.eventName,t.data);this.storage.clearFailedEvents()}))}trackSessionStart(){}trackPageData(e){}getSessionId(){return this.sessionManager.getSessionId()}getDeviceInfo(){return this.deviceInfo.getInfo()}getUTMParameters(){return this.utmTracker.getParameters()}destroy(){this.sessionManager.destroy(),this.pageTracker.destroy(),this.initialized=!1,this.logger.debug("SDK destroyed")}}new h;const l="1.0.0";export{l as VERSION,h as default};
//# sourceMappingURL=myclops-1.0.0.esm.js.map
